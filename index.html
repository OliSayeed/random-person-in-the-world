<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Population-Weighted Place + Age/Sex (IDB API, auto-load CSV parts)</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<!-- Papa Parse (city CSVs) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" crossorigin="anonymous"></script>

<style>
  :root { --bg:#0b0c0f; --panel:#111317; --muted:#a9b0bd; --text:#e9eef6; --accent:#6aa0ff; --border:#1f2430; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
            font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial;}
  .leaflet-container{background:#0a0d12;}
  .topbar{position:fixed;z-index:1000;top:0;left:0;right:0;background:#0e1117;border-bottom:1px solid var(--border);
          display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 12px;box-shadow:0 2px 12px rgba(0,0,0,.35);}
  .brand{font-size:18px;font-weight:800;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  #map{position:fixed;top:56px;left:0;right:0;bottom:0;min-height:60vh;}
  .panel{position:fixed;top:64px;left:12px;background:#0d0f13;border:1px solid var(--border);border-radius:12px;padding:12px;max-width:360px;display:none;}
  .panel.open{display:block;}
  .panel h1{margin:0 0 4px;font-size:20px;letter-spacing:.2px;}
  .kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px;margin-top:8px;font-size:13px;color:var(--muted);}
  .kv b{color:var(--text);}
  .toast{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:#111827;border:1px solid #263044;border-radius:10px;
         padding:10px 14px;font-weight:600;letter-spacing:.2px;display:none;}
  .toast.show{display:block;}
</style>
</head>
<body>

<div class="topbar">
  <div class="brand">Population-Weighted Place + Age/Sex</div>
</div>

<div id="map"></div>

<div id="infoPanel" class="panel">
  <h1 id="placeTitle">—</h1>
  <div class="kv">
    <div>Where</div><div><b id="placeSub">—</b></div>
    <div>Population</div><div><b id="placePop">—</b></div>
    <div>Random sex</div><div><b id="sexLbl">—</b></div>
    <div>Random age</div><div><b id="ageLbl">—</b></div>
  </div>
</div>

<div id="toast" class="toast">Loading…</div>

<script>
/* ========= Config ========= */
const YEAR = 2024; // target year for age distribution
const CITY_PARTS = ['data/geonames_part1.csv','data/geonames_part2.csv'];
const CITY_SINGLE = 'data/geonames_10k.csv';
const IDB_BASE = 'https://api.census.gov/data/timeseries/idb/1year'; // U.S. Census IDB

/* ========= Map (v3.2 dynamics) ========= */
let map=null, labelsOverlay=null, currentMarker=null;
(function initMap(){
  map = L.map('map',{minZoom:1.5,worldCopyJump:true,attributionControl:true}).setView([20,0],2);
  L.tileLayer('https://basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',{attribution:'© OpenStreetMap © CARTO'}).addTo(map);
  labelsOverlay = L.tileLayer('https://basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png',{attribution:''});
  map.setMaxBounds([[-85,-200],[85,200]]);
})();

/* ========= UI helpers ========= */
const panel      = document.getElementById('infoPanel');
const placeTitle = document.getElementById('placeTitle');
const placeSubEl = document.getElementById('placeSub');
const placePopEl = document.getElementById('placePop');
const sexLbl     = document.getElementById('sexLbl');
const ageLbl     = document.getElementById('ageLbl');
const toast      = document.getElementById('toast');

function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1400); }
function fmt(n){ try{return Number(n).toLocaleString();}catch{ return String(n); } }
function normalizeHeader(h){ return (h||'').toString().replace(/^\uFEFF/,'').trim(); }
function normName(s){ return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim().toLowerCase(); }

/* ========= City CSV parsing ========= */
function parseRows(rows){
  const out=[];
  for(const r of rows){
    const keys=Object.keys(r); if(!keys.length) continue;
    const lower={}; for(const k of keys){ lower[normalizeHeader(k).toLowerCase()]=k; }
    const name=(r[lower['name']] ?? r[lower['ascii name']] ?? r[lower['city']] ?? r[lower['placename']] ?? '').toString().trim();
    if(!name) continue;
    let latRaw=r[lower['lat']] ?? r[lower['latitude']] ?? r[lower['lat (deg)']] ?? r[lower['y']];
    let lonRaw=r[lower['lon']] ?? r[lower['long']] ?? r[lower['lng']] ?? r[lower['longitude']] ?? r[lower['x']];
    if((latRaw==null || lonRaw==null) && (r['Coordinates']!=null || r['Coordinates ']!=null)){
      const parts=(r['Coordinates'] ?? r['Coordinates ']).toString().split(',',2); if(parts.length===2){ latRaw=parts[0].trim(); lonRaw=parts[1].trim(); }
    }
    const lat=parseFloat(String(latRaw).replace(',','.'));
    const lon=parseFloat(String(lonRaw).replace(',','.'));
    if(!isFinite(lat)||!isFinite(lon)) continue;
    if(lat<-90||lat>90||lon<-180||lon>180) continue;
    const popRaw=r['Population'] ?? r['population'] ?? r['pop'] ?? r['Population '] ?? r['POP'] ?? null;
    const pop=Number.isFinite(parseInt(popRaw,10)) ? parseInt(popRaw,10) : null;
    const country=(r['Country name EN'] ?? r['Country'] ?? r['Country Name'] ?? r['country'] ?? '').toString().trim() || null;
    const sub=(r['Admin1'] ?? r['Admin1 Name'] ?? r['Sub'] ?? r['Subdivision'] ?? '').toString().trim() || null;
    out.push({ name, lat, lon, pop, country, sub });
  }
  return out;
}
function papaFetch(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url,{download:true,header:true,skipEmptyLines:true,transformHeader:normalizeHeader,
      complete: res=>resolve(res.data), error: err=>reject(err)});
  });
}
async function loadCityData(){
  // Expect the two split files; if either fails, try the single file
  try{
    const [p1,p2] = await Promise.all([papaFetch(CITY_PARTS[0]), papaFetch(CITY_PARTS[1])]);
    const rows = [...p1,...p2];
    const parsed = parseRows(rows);
    if(parsed.length) return parsed;
  }catch(_){}
  try{
    const single = await papaFetch(CITY_SINGLE);
    const parsed = parseRows(single);
    if(parsed.length) return parsed;
  }catch(_){}
  throw new Error('Could not load city CSVs from /data/.');
}

/* ========= IDB API: country mapping & age table ========= */
let idbCountryList = null; // [{genc:'GB', name:'United Kingdom', norm:'united kingdom'}, ...]
const NAME_FIX = new Map(Object.entries({
  "cote d'ivoire":"côte d'ivoire",
  "ivory coast":"côte d'ivoire",
  "congo (kinshasa)":"democratic republic of the congo",
  "congo, democratic republic of the":"democratic republic of the congo",
  "congo (brazzaville)":"congo",
  "russia":"russian federation",
  "south korea":"republic of korea",
  "north korea":"people's republic of korea",
  "swaziland":"eswatini",
  "czech republic":"czechia",
  "macedonia":"tfyr macedonia"
}));
async function fetchIdbCountryList(){
  if(idbCountryList) return idbCountryList;
  const url = `${IDB_BASE}?get=NAME,GENC&YR=${YEAR}&for=genc%20standard%20countries%20and%20areas:*`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('Failed to load IDB country list');
  const json = await res.json();
  idbCountryList = json.slice(1).map(r=>({ name:r[0], genc:r[1], norm:normName(r[0]) }));
  return idbCountryList;
}
function bestCountryMatch(input){
  if(!input) return null;
  let q = normName(input);
  if(NAME_FIX.has(q)) q = NAME_FIX.get(q);
  const list = idbCountryList || [];
  const exact = list.find(c=>c.norm===q);
  if(exact) return exact;
  const starts = list.find(c=>c.norm.startsWith(q)) || list.find(c=>q.startsWith(c.norm));
  if(starts) return starts;
  return list.find(c=>c.norm.includes(q)) || null;
}
async function fetchIdbAgeTable(gencCode){
  // AGE=0:100, SEX=1 (male) and 2 (female)
  const url = `${IDB_BASE}?get=AGE,SEX,POP&YR=${YEAR}&AGE=0:100&SEX=1,2&for=genc%20standard%20countries%20and%20areas:${encodeURIComponent(gencCode)}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('Failed to load IDB age table');
  const data = await res.json();
  const rows = data.slice(1);
  const male = Array(101).fill(0), female = Array(101).fill(0);
  for(const r of rows){
    const age = parseInt(r[0],10); const sex = parseInt(r[1],10); const pop = Number(r[2]);
    if(Number.isFinite(age) && age>=0 && age<=100 && Number.isFinite(pop)){
      if(sex===1) male[age]+=pop; else if(sex===2) female[age]+=pop;
    }
  }
  return {male, female};
}

/* ========= Sampling ========= */
function pickWeightedIndex(weights){
  let total=0; for(const w of weights){ total += (w>0? w:0); }
  if(total<=0) return Math.floor(Math.random()*weights.length);
  let r=Math.random()*total;
  for(let i=0;i<weights.length;i++){ r -= (weights[i]>0?weights[i]:0); if(r<=0) return i; }
  return weights.length-1;
}
function sampleSexFrom(maleArr, femaleArr){
  const m = maleArr.reduce((s,x)=>s+x,0), f = femaleArr.reduce((s,x)=>s+x,0);
  const t = m+f;
  if(t<=0) return Math.random()<0.5 ? 'Male' : 'Female';
  return (Math.random()*t < m) ? 'Male' : 'Female';
}
function sampleAgeFrom(maleArr, femaleArr, sex){
  const weights = (sex==='Male') ? maleArr : femaleArr;
  const idx = pickWeightedIndex(weights);
  return idx; // 0..100 (100 means 100+)
}

/* ========= City choosing (population-weighted) ========= */
function pickWeightedByPopulation(cities){
  const withPop=cities.filter(c=>Number.isFinite(c.pop)&&c.pop>0);
  const pool=withPop.length?withPop:cities;
  const total=withPop.length?withPop.reduce((s,c)=>s+c.pop,0):pool.length;
  let r=Math.random()*total;
  if(withPop.length){
    for(const c of withPop){ r-=c.pop; if(r<=0) return c; }
    return withPop[withPop.length-1];
  }else{
    return pool[Math.floor(Math.random()*pool.length)];
  }
}

/* ========= Display ========= */
function showPlace(c, sex, age){
  if(currentMarker){ map.removeLayer(currentMarker); currentMarker=null; }
  const label=[c.name, c.sub||null, c.country||null].filter(Boolean).join(' — ');
  if(labelsOverlay && !map.hasLayer(labelsOverlay)) labelsOverlay.addTo(map);

  map.flyTo([c.lat, c.lon], 9, {animate:true, duration:2.6, easeLinearity:0.2});
  const doAfter = ()=>{
    map.off('moveend', doAfter);
    currentMarker=L.marker([c.lat,c.lon]).addTo(map);
    const popStr = c.pop!=null ? fmt(c.pop) : '—';
    currentMarker.bindPopup(`<b>${label}</b><br>Population: ${popStr}<br>${sex}${age!=null?`, age ${age}`:''}`).openPopup();
  };
  map.on('moveend', doAfter);

  placeTitle.textContent = c.name;
  placeSubEl.textContent = [c.sub, c.country].filter(Boolean).join(' — ') || '—';
  placePopEl.textContent = c.pop!=null ? fmt(c.pop) : '—';
  sexLbl.textContent     = sex || '—';
  ageLbl.textContent     = (age!=null ? String(age) : '—');
  panel.classList.add('open');
}

/* ========= Orchestration ========= */
async function chooseAndShow(cities){
  const city = pickWeightedByPopulation(cities);
  let sex='Male', age=null;

  try{
    await fetchIdbCountryList();
    const found = bestCountryMatch(city.country||'');
    if(!found) throw new Error('No IDB match for country');
    const tbl = await fetchIdbAgeTable(found.genc);
    sex = sampleSexFrom(tbl.male, tbl.female);        // empirical sex ratio
    age = sampleAgeFrom(tbl.male, tbl.female, sex);   // empirical age distribution
  }catch(e){
    // graceful fallback if API fails (rare)
    sex = (Math.random()<0.5?'Male':'Female');
    age = null;
    console.warn('Age/sex fetch failed, using fallback:', e);
  }
  showPlace(city, sex, age);
}

/* ========= Boot ========= */
window.addEventListener('DOMContentLoaded', async ()=>{
  showToast('Loading…');
  try{
    const cities = await loadCityData();   // auto-load from /data/
    await fetchIdbCountryList();           // warm the mapping
    await chooseAndShow(cities);           // pick and show
  }catch(e){
    console.error(e);
    showToast('Could not load city CSVs from /data/.');
  }
});
</script>
</body>
</html>
