<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Population-Weighted Place + Age/Sex (IDB API, v4)</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<!-- Papa Parse (city CSVs) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" crossorigin="anonymous"></script>

<style>
  :root { --bg:#0b0c0f; --panel:#111317; --muted:#a9b0bd; --text:#e9eef6; --accent:#6aa0ff; --border:#1f2430; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
            font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial;}
  .leaflet-container{background:#0a0d12;}
  .topbar{position:fixed;z-index:1000;top:0;left:0;right:0;background:#0e1117;border-bottom:1px solid var(--border);
          display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 12px;box-shadow:0 2px 12px rgba(0,0,0,.35);}
  .brand{font-size:18px;font-weight:800;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
  .muted{color:var(--muted);font-size:13px;}
  select{background:#0d0f13;border:1px solid var(--border);color:#e9eef6;border-radius:10px;padding:8px 10px;}
  label.file{display:inline-flex;align-items:center;gap:8px;background:#1a2233;border:1px solid #2a3347;border-radius:10px;padding:8px 10px;cursor:pointer;}
  input[type="file"]{accent-color:var(--accent);}
  #map{position:fixed;top:56px;left:0;right:0;bottom:0;min-height:60vh;}
  .panel{position:fixed;top:64px;left:12px;background:#0d0f13;border:1px solid var(--border);border-radius:12px;padding:12px;max-width:360px;display:none;}
  .panel.open{display:block;}
  .panel h1{margin:0 0 4px;font-size:20px;letter-spacing:.2px;}
  .kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px;margin-top:8px;font-size:13px;color:var(--muted);}
  .kv b{color:var(--text);}
  #dropzone{position:fixed;inset:56px 0 0 0;display:flex;align-items:center;justify-content:center;border:2px dashed #2a3347;color:#97a0b2;
            font-weight:600;letter-spacing:.3px;pointer-events:none;opacity:0;transition:.2s;}
  #dropzone.show{opacity:1;pointer-events:auto;background:rgba(20,24,32,.6);backdrop-filter:blur(2px);}
  .toast{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:#111827;border:1px solid #263044;border-radius:10px;
         padding:10px 14px;font-weight:600;letter-spacing:.2px;display:none;}
  .toast.show{display:block;}
</style>
</head>
<body>

<div class="topbar">
  <div class="brand">Population-Weighted Place + Age/Sex</div>
  <div class="controls">
    <label class="file">
      <span>Choose city CSV(s):</span>
      <input id="fileInput" type="file" accept=".csv,text/csv" multiple>
    </label>
    <label>Sex mode:
      <select id="sexMode">
        <option value="50" selected>50:50 (exact)</option>
        <option value="real">Use country sex ratio (IDB)</option>
      </select>
    </label>
    <span class="muted">Auto-loads /data/geonames_part1.csv + /data/geonames_part2.csv, or /data/geonames_10k.csv. Ages/sex from U.S. Census IDB (2024).</span>
  </div>
</div>

<div id="map"></div>
<div id="dropzone">Drop your <b style="margin-left:6px;">city CSV(s)</b> here</div>

<div id="infoPanel" class="panel">
  <h1 id="placeTitle">—</h1>
  <div class="kv">
    <div>Where</div><div><b id="placeSub">—</b></div>
    <div>Population</div><div><b id="placePop">—</b></div>
    <div>Random sex</div><div><b id="sexLbl">—</b></div>
    <div>Random age</div><div><b id="ageLbl">—</b></div>
  </div>
</div>

<div id="toast" class="toast">Loading…</div>

<script>
/* ========= Config ========= */
const YEAR = 2024; // target year for age distribution
const CITY_PARTS = ['data/geonames_part1.csv','data/geonames_part2.csv'];
const CITY_SINGLE = 'data/geonames_10k.csv';
const IDB_BASE = 'https://api.census.gov/data/timeseries/idb/1year'; // U.S. Census IDB API (single-year)

/* ========= Map (v3.2 dynamics) ========= */
let map=null, labelsOverlay=null, currentMarker=null;
(function initMap(){
  map = L.map('map',{minZoom:1.5,worldCopyJump:true,attributionControl:true}).setView([20,0],2);
  L.tileLayer('https://basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',{attribution:'© OpenStreetMap © CARTO'}).addTo(map);
  labelsOverlay = L.tileLayer('https://basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png',{attribution:''});
  map.setMaxBounds([[-85,-200],[85,200]]);
})();

/* ========= UI ========= */
const fileInput  = document.getElementById('fileInput');
const dropzone   = document.getElementById('dropzone');
const panel      = document.getElementById('infoPanel');
const placeTitle = document.getElementById('placeTitle');
const placeSubEl = document.getElementById('placeSub');
const placePopEl = document.getElementById('placePop');
const sexLbl     = document.getElementById('sexLbl');
const ageLbl     = document.getElementById('ageLbl');
const sexModeSel = document.getElementById('sexMode');
const toast      = document.getElementById('toast');

function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1400); }
function fmt(n){ try{return Number(n).toLocaleString();}catch{ return String(n); } }
function normalizeHeader(h){ return (h||'').toString().replace(/^\uFEFF/,'').trim(); }
function normName(s){ return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim().toLowerCase(); }

/* ========= City CSV parsing ========= */
function parseRows(rows){
  const out=[];
  for(const r of rows){
    const keys=Object.keys(r); if(!keys.length) continue;
    const lower={}; for(const k of keys){ lower[normalizeHeader(k).toLowerCase()]=k; }
    const name=(r[lower['name']] ?? r[lower['ascii name']] ?? r[lower['city']] ?? r[lower['placename']] ?? '').toString().trim();
    if(!name) continue;
    let latRaw=r[lower['lat']] ?? r[lower['latitude']] ?? r[lower['lat (deg)']] ?? r[lower['y']];
    let lonRaw=r[lower['lon']] ?? r[lower['long']] ?? r[lower['lng']] ?? r[lower['longitude']] ?? r[lower['x']];
    if((latRaw==null || lonRaw==null) && (r['Coordinates']!=null || r['Coordinates ']!=null)){
      const parts=(r['Coordinates'] ?? r['Coordinates ']).toString().split(',',2); if(parts.length===2){ latRaw=parts[0].trim(); lonRaw=parts[1].trim(); }
    }
    const lat=parseFloat(String(latRaw).replace(',','.'));
    const lon=parseFloat(String(lonRaw).replace(',','.'));
    if(!isFinite(lat)||!isFinite(lon)) continue;
    if(lat<-90||lat>90||lon<-180||lon>180) continue;
    const popRaw=r['Population'] ?? r['population'] ?? r['pop'] ?? r['Population '] ?? r['POP'] ?? null;
    const pop=Number.isFinite(parseInt(popRaw,10)) ? parseInt(popRaw,10) : null;
    const country=(r['Country name EN'] ?? r['Country'] ?? r['Country Name'] ?? r['country'] ?? '').toString().trim() || null;
    const sub=(r['Admin1'] ?? r['Admin1 Name'] ?? r['Sub'] ?? r['Subdivision'] ?? '').toString().trim() || null;
    out.push({ name, lat, lon, pop, country, sub });
  }
  return out;
}
function papaFetch(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url,{download:true,header:true,skipEmptyLines:true,transformHeader:normalizeHeader,
      complete: res=>resolve(res.data), error: err=>reject(err)});
  });
}
async function loadCityData(){
  try{
    const [p1,p2] = await Promise.all([papaFetch(CITY_PARTS[0]), papaFetch(CITY_PARTS[1])]);
    const rows = [...p1,...p2];
    const parsed = parseRows(rows);
    if(parsed.length) return parsed;
  }catch(_){}
  try{
    const single = await papaFetch(CITY_SINGLE);
    const parsed = parseRows(single);
    if(parsed.length) return parsed;
  }catch(_){}
  return null; // fall back to user upload
}

/* ========= IDB API helpers (single-year ages by sex) ========= */
/* We’ll fetch a master list of {GENC, NAME} once, then map your CSV’s country names to the best match. */
let idbCountryList = null; // [{genc:'GB', name:'United Kingdom'}, ...]
const NAME_FIX = new Map(Object.entries({
  // small alias fixups for common variants
  'cote d\'ivoire':'côte d\'ivoire',
  'ivory coast':'côte d\'ivoire',
  'congo (kinshasa)':'democratic republic of the congo',
  'congo, democratic republic of the':'democratic republic of the congo',
  'congo (brazzaville)':'congo',
  'russia':'russian federation',
  'south korea':'republic of korea',
  'north korea':'people\'s republic of korea',
  'swaziland':'eswatini',
  'czech republic':'czechia',
  'macedonia':'tfyr macedonia',
}));

async function fetchIdbCountryList(){
  if(idbCountryList) return idbCountryList;
  const url = `${IDB_BASE}?get=NAME,GENC&YR=${YEAR}&for=genc%20standard%20countries%20and%20areas:*`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('Failed to load IDB country list');
  const json = await res.json(); // first row is headers
  const rows = json.slice(1).map(r=>({ name: r[0], genc: r[1] }));
  // normalize names for matching
  idbCountryList = rows.map(r=>({ genc:r.genc, name:r.name, norm: normName(r.name) }));
  return idbCountryList;
}
function bestCountryMatch(input){
  if(!input) return null;
  let q = normName(input);
  if(NAME_FIX.has(q)) q = NAME_FIX.get(q);
  // exact norm match
  const exact = idbCountryList.find(c=>c.norm===q);
  if(exact) return exact;
  // startswith / includes fallback
  const starts = idbCountryList.find(c=>c.norm.startsWith(q)) || idbCountryList.find(c=>q.startsWith(c.norm));
  if(starts) return starts;
  // very rough contains (last resort)
  return idbCountryList.find(c=>c.norm.includes(q)) || null;
}
async function fetchIdbAgeTable(gencCode){
  // AGE=0:100, SEX=1 (male) and 2 (female)
  const url = `${IDB_BASE}?get=AGE,SEX,POP&YR=${YEAR}&AGE=0:100&SEX=1,2&for=genc%20standard%20countries%20and%20areas:${encodeURIComponent(gencCode)}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('Failed to load IDB age table');
  const data = await res.json(); // [ ["AGE","SEX","POP","time","NAME","GENC","..."], [...], ... ]
  const rows = data.slice(1);
  const male = Array(101).fill(0), female = Array(101).fill(0);
  for(const r of rows){
    const age = parseInt(r[0],10); const sex = parseInt(r[1],10); const pop = Number(r[2]);
    if(Number.isFinite(age) && age>=0 && age<=100 && Number.isFinite(pop)){
      if(sex===1) male[age]+=pop; else if(sex===2) female[age]+=pop;
    }
  }
  return {male, female};
}

/* ========= Sampling from distributions ========= */
function pickWeightedIndex(weights){
  let total=0; for(const w of weights){ total += (w>0? w:0); }
  if(total<=0) return Math.floor(Math.random()*weights.length);
  let r=Math.random()*total;
  for(let i=0;i<weights.length;i++){ r -= (weights[i]>0?weights[i]:0); if(r<=0) return i; }
  return weights.length-1;
}
function sampleSexFrom(maleArr, femaleArr, mode){
  if(mode==='50') return Math.random()<0.5 ? 'Male' : 'Female';
  const m = maleArr.reduce((s,x)=>s+x,0), f = femaleArr.reduce((s,x)=>s+x,0);
  const t = m+f;
  if(t<=0) return Math.random()<0.5 ? 'Male' : 'Female';
  return (Math.random()*t < m) ? 'Male' : 'Female';
}
function sampleAgeFrom(maleArr, femaleArr, sex){
  const weights = (sex==='Male') ? maleArr : femaleArr;
  const idx = pickWeightedIndex(weights);
  return idx; // 0..100 (100 means 100+)
}

/* ========= City choosing (population-weighted) ========= */
function pickWeightedByPopulation(cities){
  const withPop=cities.filter(c=>Number.isFinite(c.pop)&&c.pop>0);
  const pool=withPop.length?withPop:cities;
  const total=withPop.length?withPop.reduce((s,c)=>s+c.pop,0):pool.length;
  let r=Math.random()*total;
  if(withPop.length){
    for(const c of withPop){ r-=c.pop; if(r<=0) return c; }
    return withPop[withPop.length-1];
  }else{
    return pool[Math.floor(Math.random()*pool.length)];
  }
}

/* ========= Display ========= */
function showPlace(c, sex, age){
  if(currentMarker){ map.removeLayer(currentMarker); currentMarker=null; }
  const label=[c.name, c.sub||null, c.country||null].filter(Boolean).join(' — ');
  if(labelsOverlay && !map.hasLayer(labelsOverlay)) labelsOverlay.addTo(map);

  map.flyTo([c.lat, c.lon], 9, {animate:true, duration:2.6, easeLinearity:0.2});
  const doAfter = ()=>{
    map.off('moveend', doAfter);
    currentMarker=L.marker([c.lat,c.lon]).addTo(map);
    const popStr = c.pop!=null ? fmt(c.pop) : '—';
    currentMarker.bindPopup(`<b>${label}</b><br>Population: ${popStr}<br>${sex}${age!=null?`, age ${age}`:''}`).openPopup();
  };
  map.on('moveend', doAfter);

  document.getElementById('placeTitle').textContent = c.name;
  document.getElementById('placeSub').textContent = [c.sub, c.country].filter(Boolean).join(' — ') || '—';
  document.getElementById('placePop').textContent = c.pop!=null ? fmt(c.pop) : '—';
  document.getElementById('sexLbl').textContent   = sex || '—';
  document.getElementById('ageLbl').textContent   = (age!=null ? String(age) : '—');
  panel.classList.add('open');
}

/* ========= Orchestration ========= */
async function chooseAndShow(cities){
  const city = pickWeightedByPopulation(cities);
  let sex='Male', age=null;

  try{
    // 1) map country name -> GENC (ISO-2-ish) via live list
    const list = await fetchIdbCountryList();
    const found = bestCountryMatch(city.country||'');
    if(!found) throw new Error('No IDB match for country');
    // 2) fetch age-by-sex table
    const tbl = await fetchIdbAgeTable(found.genc);
    // 3) sample sex & age
    sex = sampleSexFrom(tbl.male, tbl.female, sexModeSel.value);
    age = sampleAgeFrom(tbl.male, tbl.female, sex);
  }catch(e){
    // graceful fallback
    sex = (sexModeSel.value==='50' ? (Math.random()<0.5?'Male':'Female') : 'Male');
    age = null;
    console.warn('Age/sex fetch failed, using fallback:', e);
  }
  showPlace(city, sex, age);
}

/* ========= Upload/drag handlers (accept 1 or 2 files) ========= */
function parseUploadedFiles(fileList){
  return new Promise((resolve,reject)=>{
    const files = Array.from(fileList||[]);
    if(!files.length) return reject(new Error('No files'));
    const results=[]; let done=0;
    files.forEach(f=>{
      Papa.parse(f,{header:true,skipEmptyLines:true,transformHeader:normalizeHeader,
        complete: res=>{ results.push(res.data); if(++done===files.length) resolve([].concat(...results)); },
        error: _=>{ if(++done===files.length) resolve([].concat(...results)); }
      });
    });
  });
}
function normalizeHeader(h){ return (h||'').toString().replace(/^\uFEFF/,'').trim(); }
function looksLikeHTML(text){ return /^\s*<!doctype html>|^\s*<html/i.test(text); }

function handleFiles(files){
  if(!files || !files.length) return;
  showToast('Parsing city file(s)…');
  parseUploadedFiles(files).then(rows=>{
    const cities=parseRows(rows);
    if(!cities.length) return alert('No valid rows with name/lat/lon were found.');
    chooseAndShow(cities);
  }).catch(err=>alert(err.message||String(err)));
}
fileInput.addEventListener('change',(e)=>handleFiles(e.target.files));
['dragenter','dragover'].forEach(ev=>{
  window.addEventListener(ev,(e)=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.add('show'); });
});
['dragleave','drop'].forEach(ev=>{
  window.addEventListener(ev,(e)=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('show'); });
});
window.addEventListener('drop',(e)=>handleFiles(e.dataTransfer && e.dataTransfer.files));

/* ========= Boot ========= */
window.addEventListener('DOMContentLoaded', async ()=>{
  showToast('Loading…');
  try{
    // Preload IDB country list so first pick is fast
    await fetchIdbCountryList();
  }catch(e){ console.warn('IDB country list fetch warning:', e); }

  try{
    const auto = await loadCityData();
    if(auto && auto.length){
      chooseAndShow(auto);
    }else{
      showToast('Upload one or two city CSV files to start');
    }
  }catch(_){
    showToast('Upload one or two city CSV files to start');
  }
});
</script>
</body>
</html>
