<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Population-Weighted Place + Age/Sex (v3.3)</title>

<!-- Leaflet -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin="anonymous"
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin="anonymous"
></script>

<!-- Papa Parse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" crossorigin="anonymous"></script>

<style>
  :root { --bg:#0b0c0f; --panel:#111317; --muted:#a9b0bd; --text:#e9eef6;
          --accent:#6aa0ff; --good:#22c55e; --mid:#f59e0b; --border:#1f2430; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
            font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial;}
  .leaflet-container{background:#0a0d12;}

  .topbar{position:fixed;z-index:1000;top:0;left:0;right:0;background:#0e1117;border-bottom:1px solid var(--border);
          display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 12px;box-shadow:0 2px 12px rgba(0,0,0,.35);}
  .brand{font-size:18px;font-weight:800;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
  .btn{appearance:none;border:none;cursor:pointer;padding:8px 10px;border-radius:10px;background:#1a2233;color:#fff;
       transition:transform .02s ease,opacity .2s ease,background .2s ease;font-weight:600;letter-spacing:.2px;}
  .btn:hover{background:#1d2740;} .btn:active{transform:translateY(1px);} .btn.accent{background:var(--accent);color:#081021;}
  .muted{color:var(--muted);font-size:13px;}

  #map{position:fixed;top:56px;left:0;right:0;bottom:0;min-height:60vh;}
  .panel{position:fixed;top:64px;left:12px;background:#0d0f13;border:1px solid var(--border);border-radius:12px;padding:12px;max-width:360px;display:none;}
  .panel.open{display:block;}
  .panel h1{margin:0 0 4px;font-size:20px;letter-spacing:.2px;}
  .kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px;margin-top:8px;font-size:13px;color:var(--muted);}
  .kv b{color:var(--text);}

  #dropzone{position:fixed;inset:56px 0 0 0;display:flex;align-items:center;justify-content:center;border:2px dashed #2a3347;color:#97a0b2;
            font-weight:600;letter-spacing:.3px;pointer-events:none;opacity:0;transition:.2s;}
  #dropzone.show{opacity:1;pointer-events:auto;background:rgba(20,24,32,.6);backdrop-filter:blur(2px);}

  .toast{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:#111827;border:1px solid #263044;border-radius:10px;
         padding:10px 14px;font-weight:600;letter-spacing:.2px;display:none;}
  .toast.show{display:block;}

  label.file{display:inline-flex;align-items:center;gap:8px;background:#1a2233;border:1px solid #2a3347;border-radius:10px;padding:8px 10px;cursor:pointer;}
  input[type="file"]{accent-color:var(--accent);}
  select{background:#0d0f13;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:8px 10px;}
</style>
</head>
<body>

<div class="topbar">
  <div class="brand">Population-Weighted Place + Age/Sex (v3.3)</div>
  <div class="controls">
    <label class="file">
      <span>Choose city CSV:</span>
      <input id="fileInput" type="file" accept=".csv,text/csv">
    </label>
    <label>Sex mode:
      <select id="sexMode">
        <option value="50">50:50</option>
        <option value="real">Use country ratio</option>
      </select>
    </label>
  </div>
</div>

<div id="map"></div>
<div id="dropzone">Drop your <b style="margin-left:6px;">geonames_10k.csv</b> here</div>

<div id="infoPanel" class="panel">
  <h1 id="placeTitle">—</h1>
  <div class="kv">
    <div>Where</div><div><b id="placeSub">—</b></div>
    <div>Population</div><div><b id="placePop">—</b></div>
    <div>Random sex</div><div><b id="sexLbl">—</b></div>
    <div>Random age</div><div><b id="ageLbl">—</b></div>
  </div>
</div>

<div id="toast" class="toast">Loading…</div>

<script>
// ===== Map init (same dynamics as v3.2) =====
let map=null, labelsOverlay=null, currentMarker=null;
(function initMap(){
  if(typeof L==='undefined'){ alert('Leaflet failed to load.'); return; }
  map=L.map('map',{minZoom:1.5,worldCopyJump:true,attributionControl:true}).setView([20,0],2);
  const baseNoLabels=L.tileLayer('https://basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',{attribution:'© OpenStreetMap © CARTO'}).addTo(map);
  labelsOverlay=L.tileLayer('https://basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png',{attribution:''});
  map.setMaxBounds([[-85,-200],[85,200]]);
})();

// ===== UI els =====
const fileInput  = document.getElementById('fileInput');
const dropzone   = document.getElementById('dropzone');
const panel      = document.getElementById('infoPanel');
const placeTitle = document.getElementById('placeTitle');
const placeSubEl = document.getElementById('placeSub');
const placePopEl = document.getElementById('placePop');
const sexLbl     = document.getElementById('sexLbl');
const ageLbl     = document.getElementById('ageLbl');
const sexModeSel = document.getElementById('sexMode');
const toast      = document.getElementById('toast');

function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1400); }
function fmt(n){ try{return Number(n).toLocaleString();}catch(_){return String(n);} }

// ===== City CSV parsing (as in your v3.x) =====
let cachedCities=null;
function normalizeHeader(h){ return (h||'').toString().replace(/^\uFEFF/,'').trim(); }
function looksLikeHTML(text){ return /^\s*<!doctype html>|^\s*<html/i.test(text); }
function parseRows(rows){
  const out=[];
  for(const r of rows){
    const keys=Object.keys(r); if(!keys.length) continue;
    const lower={}; for(const k of keys){ lower[normalizeHeader(k).toLowerCase()]=k; }
    const name=(r[lower['name']] ?? r[lower['ascii name']] ?? r[lower['city']] ?? r[lower['placename']] ?? '').toString().trim();
    if(!name) continue;
    let latRaw=r[lower['lat']] ?? r[lower['latitude']] ?? r[lower['lat (deg)']] ?? r[lower['y']];
    let lonRaw=r[lower['lon']] ?? r[lower['long']] ?? r[lower['lng']] ?? r[lower['longitude']] ?? r[lower['x']];
    if((latRaw==null || lonRaw==null) && (r['Coordinates']!=null || r['Coordinates ']!=null)){
      const parts=(r['Coordinates'] ?? r['Coordinates ']).toString().split(',',2); if(parts.length===2){ latRaw=parts[0].trim(); lonRaw=parts[1].trim(); }
    }
    const lat=parseFloat(String(latRaw).replace(',','.'));
    const lon=parseFloat(String(lonRaw).replace(',','.'));
    if(!isFinite(lat)||!isFinite(lon)) continue;
    if(lat<-90||lat>90||lon<-180||lon>180) continue;
    const popRaw=r['Population'] ?? r['population'] ?? r['pop'] ?? r['Population '] ?? r['POP'] ?? null;
    const pop=Number.isFinite(parseInt(popRaw,10)) ? parseInt(popRaw,10) : null;
    const country=(r['Country name EN'] ?? r['Country'] ?? r['Country Name'] ?? r['country'] ?? '').toString().trim() || null;
    const sub=(r['Admin1'] ?? r['Admin1 Name'] ?? r['Sub'] ?? r['Subdivision'] ?? '').toString().trim() || null;
    out.push({ name, lat, lon, pop, country, sub });
  }
  return out;
}
function parseCSVFile(file){
  return new Promise((resolve,reject)=>{
    Papa.parse(file,{
      header:true, skipEmptyLines:true, transformHeader: normalizeHeader,
      complete: function(res){
        try{
          const fields=res.meta?.fields||[];
          if(!fields.length){
            const reader=new FileReader();
            reader.onload=()=>{
              const t=reader.result;
              if(looksLikeHTML(t)) reject(new Error('Got HTML instead of CSV.'));
              else reject(new Error('No header row detected.'));
            };
            reader.readAsText(file); return;
          }
          const cities=parseRows(res.data);
          if(!cities.length) return reject(new Error('No valid rows with name/lat/lon were found.'));
          resolve(cities);
        }catch(err){ reject(err); }
      },
      error: err=>reject(err)
    });
  });
}

// ===== WPP age data (loaded once from /data/) =====
let wppByCountry = new Map();     // key: normalized country name -> array of rows {age, male, female}
let wppTotals = { male:0, female:0, byAge:[] }; // global fallback
function normName(s){ return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim().toLowerCase(); }

async function loadWPP(){
  return new Promise((resolve,reject)=>{
    Papa.parse('data/wpp_age_single_year_2024.csv',{
      download:true, header:true, skipEmptyLines:true,
      complete: (res)=>{
        try{
          const rows = res.data.map(r=>({
            country: String(r.country||r.Country||'').trim(),
            age: parseInt(String(r.age||r.Age||'0'),10),
            male: Number(r.pop_male||r.male||0),
            female: Number(r.pop_female||r.female||0)
          })).filter(r=>r.country && Number.isFinite(r.age));
          wppByCountry.clear();
          const globalByAge = [];
          let gm=0,gf=0;
          for(const r of rows){
            const key = normName(r.country);
            if(!wppByCountry.has(key)) wppByCountry.set(key, []);
            wppByCountry.get(key).push({age:r.age, male:r.male, female:r.female});
            gm += r.male; gf += r.female;
            if(!globalByAge[r.age]) globalByAge[r.age]={age:r.age,male:0,female:0};
            globalByAge[r.age].male += r.male; globalByAge[r.age].female += r.female;
          }
          wppTotals.male = gm; wppTotals.female = gf; wppTotals.byAge = globalByAge.filter(Boolean);
          resolve();
        }catch(e){ reject(e); }
      },
      error: (e)=>reject(e)
    });
  });
}

function pickWeighted(items, weightFn){
  const n=items.length; if(!n) return null;
  let total=0; for(const it of items){ total += Math.max(0, weightFn(it)||0); }
  if(total<=0) return items[Math.floor(Math.random()*n)];
  let r=Math.random()*total;
  for(const it of items){ r -= Math.max(0, weightFn(it)||0); if(r<=0) return it; }
  return items[n-1];
}

function sampleSex(countryName, mode){
  if(mode==='50') return Math.random()<0.5 ? 'Male' : 'Female';
  const key=normName(countryName||'');
  const rows=wppByCountry.get(key);
  if(!rows || !rows.length){
    // use global ratio
    const t=wppTotals.male + wppTotals.female;
    if(t<=0) return Math.random()<0.5 ? 'Male' : 'Female';
    return (Math.random()*t < wppTotals.male) ? 'Male' : 'Female';
  }
  const m=rows.reduce((s,x)=>s+x.male,0), f=rows.reduce((s,x)=>s+x.female,0);
  const t=m+f; if(t<=0) return Math.random()<0.5 ? 'Male' : 'Female';
  return (Math.random()*t < m) ? 'Male' : 'Female';
}

function sampleAge(countryName, sex){
  const key=normName(countryName||'');
  const rows=wppByCountry.get(key) || wppTotals.byAge;
  const weight=(r)=> sex==='Male' ? r.male : r.female;
  const picked = pickWeighted(rows, weight);
  return picked ? picked.age : null;
}

// ===== Show chosen place + sampled sex/age =====
function showPlace(c){
  if(!map) return;
  if(currentMarker){ map.removeLayer(currentMarker); currentMarker=null; }
  const label=[c.name, c.sub||null, c.country||null].filter(Boolean).join(' — ');

  // Sample sex/age for that country (if WPP data present)
  const mode = sexModeSel.value;
  const sex  = c.country ? sampleSex(c.country, mode) : (Math.random()<0.5 ? 'Male':'Female');
  const age  = c.country ? sampleAge(c.country, sex) : null;

  // Fly + drop marker (same timing as v3.2)
  if(labelsOverlay && !map.hasLayer(labelsOverlay)) labelsOverlay.addTo(map);
  map.flyTo([c.lat, c.lon], 9, {animate:true, duration:2.6, easeLinearity:0.2});
  const doAfter = ()=>{
    map.off('moveend', doAfter);
    currentMarker=L.marker([c.lat,c.lon]).addTo(map);
    const popStr = c.pop!=null ? fmt(c.pop) : '—';
    currentMarker.bindPopup(`<b>${label}</b><br>Population: ${popStr}<br>${sex}${age!=null?`, age ${age}`:''}`).openPopup();
  };
  map.on('moveend', doAfter);

  // Side panel
  placeTitle.textContent = c.name;
  placeSubEl.textContent = [c.sub, c.country].filter(Boolean).join(' — ') || '—';
  placePopEl.textContent = c.pop!=null ? fmt(c.pop) : '—';
  sexLbl.textContent     = sex;
  ageLbl.textContent     = (age!=null ? String(age) : '—');
  panel.classList.add('open');
}

// ===== Weighted pick by population =====
function pickWeightedByPopulation(cities){
  const withPop=cities.filter(c=>Number.isFinite(c.pop)&&c.pop>0);
  const pool=withPop.length?withPop:cities;
  const total=withPop.length?withPop.reduce((s,c)=>s+c.pop,0):pool.length;
  let r=Math.random()*total;
  if(withPop.length){
    for(const c of withPop){ r-=c.pop; if(r<=0) return c; }
    return withPop[withPop.length-1];
  }else{
    return pool[Math.floor(Math.random()*pool.length)];
  }
}

// ===== Handlers =====
function handleFiles(files){
  const f=files && files[0]; if(!f) return;
  showToast('Parsing city file…');
  parseCSVFile(f).then(cities=>{
    cachedCities=cities;
    showToast('Picking a place…');
    const chosen=pickWeightedByPopulation(cities);
    showPlace(chosen);
  }).catch(err=>{
    alert(err.message || String(err));
  }).finally(()=>{ fileInput.value=''; });
}

fileInput.addEventListener('change',(e)=>handleFiles(e.target.files));
['dragenter','dragover'].forEach(ev=>{
  window.addEventListener(ev,(e)=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.add('show'); });
});
['dragleave','drop'].forEach(ev=>{
  window.addEventListener(ev,(e)=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('show'); });
});
window.addEventListener('drop',(e)=>handleFiles(e.dataTransfer && e.dataTransfer.files));

// Load WPP on boot (non-blocking; app still works without it)
window.addEventListener('DOMContentLoaded', ()=>{
  loadWPP().catch(()=>{/* ignore; we just won't have age/sex sampling */});
});
</script>
</body>
</html>
