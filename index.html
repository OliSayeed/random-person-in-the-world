<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Population-Weighted Place + Empirical Age/Sex (smart local/remote)</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<!-- Papa Parse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" crossorigin="anonymous"></script>

<style>
  :root { --bg:#0b0c0f; --panel:#111317; --muted:#a9b0bd; --text:#e9eef6; --accent:#6aa0ff; --border:#1f2430; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
            font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial;}
  .leaflet-container{background:#0a0d12;}
  .topbar{position:fixed;z-index:1000;top:0;left:0;right:0;background:#0e1117;border-bottom:1px solid var(--border);
          display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 12px;box-shadow:0 2px 12px rgba(0,0,0,.35);}
  .brand{font-size:18px;font-weight:800;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  #map{position:fixed;top:56px;left:0;right:0;bottom:0;min-height:60vh;}
  .panel{position:fixed;top:64px;left:12px;background:#0d0f13;border:1px solid var(--border);border-radius:12px;padding:12px;max-width:360px;display:none;}
  .panel.open{display:block;}
  .panel h1{margin:0 0 4px;font-size:20px;letter-spacing:.2px;}
  .kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px;margin-top:8px;font-size:13px;color:var(--muted);}
  .kv b{color:var(--text);}
  .toast{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:#111827;border:1px solid #263044;border-radius:10px;
         padding:10px 14px;font-weight:600;letter-spacing:.2px;display:none;}
  .toast.show{display:block;}
  /* Hidden file input (auto-shown only if remote fetch fails) */
  #fileWrap{position:fixed;inset:56px 0 0 0;display:none;align-items:center;justify-content:center;}
  #fileWrap.open{display:flex;}
  label.file{display:inline-flex;align-items:center;gap:8px;background:#1a2233;border:1px solid #2a3347;border-radius:10px;padding:12px 14px;cursor:pointer;color:#e9eef6;font-weight:700;}
  input[type="file"]{display:none;}
</style>
</head>
<body>

<div class="topbar">
  <div class="brand">Population-Weighted Place + Empirical Age/Sex</div>
</div>

<div id="map"></div>

<div id="fileWrap">
  <label class="file">
    <span>Choose your city CSV (or the two parts)</span>
    <input id="fileInput" type="file" accept=".csv,text/csv" multiple>
  </label>
</div>

<div id="infoPanel" class="panel">
  <h1 id="placeTitle">—</h1>
  <div class="kv">
    <div>Where</div><div><b id="placeSub">—</b></div>
    <div>Population</div><div><b id="placePop">—</b></div>
    <div>Random sex</div><div><b id="sexLbl">—</b></div>
    <div>Random age</div><div><b id="ageLbl">—</b></div>
  </div>
</div>

<div id="toast" class="toast">Loading…</div>

<script>
/* ========= Config ========= */
const YEAR = 2024;
const CITY_PARTS = ['geonames_part1.csv','geonames_part2.csv']; // same folder as index.html
const CITY_SINGLE = 'geonames_10k.csv';
const IDB_BASE = 'https://api.census.gov/data/timeseries/idb/1year';

/* ========= Map (v3.2 dynamics) ========= */
let map=null, labelsOverlay=null, currentMarker=null;
(function initMap(){
  map = L.map('map',{minZoom:1.5,worldCopyJump:true,attributionControl:true}).setView([20,0],2);
  L.tileLayer('https://basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',{attribution:'© OpenStreetMap © CARTO'}).addTo(map);
  labelsOverlay = L.tileLayer('https://basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png',{attribution:''});
  map.setMaxBounds([[-85,-200],[85,200]]);
})();

/* ========= UI ========= */
const panel      = document.getElementById('infoPanel');
const placeTitle = document.getElementById('placeTitle');
const placeSubEl = document.getElementById('placeSub');
const placePopEl = document.getElementById('placePop');
const sexLbl     = document.getElementById('sexLbl');
const ageLbl     = document.getElementById('ageLbl');
const toast      = document.getElementById('toast');
const fileWrap   = document.getElementById('fileWrap');
const fileInput  = document.getElementById('fileInput');

function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1400); }
function fmt(n){ try{return Number(n).toLocaleString();}catch{ return String(n); } }
function normalizeHeader(h){ return (h||'').toString().replace(/^\uFEFF/,'').trim(); }
function normName(s){ return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim().toLowerCase(); }

/* ========= Fast one-pass weighted sampler (Efraimidis–Spirakis) ========= */
function makeKey(w){ if(!(w>0)) return Infinity; return -Math.log(Math.random())/w; }

/* ========= CSV helpers ========= */
function parseRowToCity(r){
  const lower={}; for(const k of Object.keys(r)){ lower[normalizeHeader(k).toLowerCase()]=k; }
  const name=(r[lower['name']] ?? r[lower['ascii name']] ?? r[lower['city']] ?? r[lower['placename']] ?? '').toString().trim();
  if(!name) return null;
  let latRaw=r[lower['lat']] ?? r[lower['latitude']] ?? r[lower['lat (deg)']] ?? r[lower['y']];
  let lonRaw=r[lower['lon']] ?? r[lower['long']] ?? r[lower['lng']] ?? r[lower['longitude']] ?? r[lower['x']];
  if((latRaw==null || lonRaw==null) && (r['Coordinates']!=null || r['Coordinates ']!=null)){
    const parts=(r['Coordinates'] ?? r['Coordinates ']).toString().split(',',2); if(parts.length===2){ latRaw=parts[0].trim(); lonRaw=parts[1].trim(); }
  }
  const lat=parseFloat(String(latRaw).replace(',','.'));
  const lon=parseFloat(String(lonRaw).replace(',','.'));
  if(!isFinite(lat)||!isFinite(lon) || lat<-90||lat>90||lon<-180||lon>180) return null;
  const popRaw=r['Population'] ?? r['population'] ?? r['pop'] ?? r['Population '] ?? r['POP'] ?? null;
  const pop=Number.isFinite(parseInt(popRaw,10)) ? parseInt(popRaw,10) : null;
  const country=(r['Country name EN'] ?? r['Country'] ?? r['Country Name'] ?? r['country'] ?? '').toString().trim() || null;
  const sub=(r['Admin1'] ?? r['Admin1 Name'] ?? r['Sub'] ?? r['Subdivision'] ?? '').toString().trim() || null;
  return { name, lat, lon, pop, country, sub };
}

/* Stream and return ONE weighted-random city from a remote URL */
function streamPickURL(url){
  return new Promise((resolve,reject)=>{
    let best=null;
    Papa.parse(url,{
      download:true, header:true, skipEmptyLines:true, worker:true,
      step: (res)=>{
        const c=parseRowToCity(res.data); if(!c) return;
        const w=(c.pop && c.pop>0)?c.pop:1;
        const key=makeKey(w);
        if(!best || key<best._key) best={...c,_key:key};
      },
      complete: ()=> best?resolve(best):reject(new Error('No valid rows in '+url)),
      error: (err)=>reject(err)
    });
  });
}

/* Read from local files (upload) and return ONE weighted-random city */
function pickFromFiles(files){
  return new Promise((resolve,reject)=>{
    if(!files || !files.length) return reject(new Error('No files selected'));
    let best=null, pending=files.length, sawAny=false;
    for(const f of files){
      Papa.parse(f,{header:true,skipEmptyLines:true,worker:true,
        step: (res)=>{
          const c=parseRowToCity(res.data); if(!c) return;
          sawAny=true;
          const w=(c.pop && c.pop>0)?c.pop:1;
          const key=makeKey(w);
          if(!best || key<best._key) best={...c,_key:key};
        },
        complete: ()=>{ if(--pending===0) best?resolve(best):reject(new Error(sawAny?'No valid rows found.':'No rows found.')); },
        error: (err)=>{ if(--pending===0) reject(err); }
      });
    }
  });
}

/* ========= Try remote first (fast timeout), then local upload fallback ========= */
async function tryRemoteThenLocal(){
  // Short-circuit: if running file:// origin, remote fetch of sibling files will fail — go straight to upload
  if(location.protocol === 'file:'){
    fileWrap.classList.add('open');
    return new Promise((resolve,reject)=>{
      fileInput.onchange = async (e)=>{ try{ const city=await pickFromFiles(e.target.files); resolve(city); } catch(err){ reject(err); } };
    });
  }

  // Remote attempt with tight timeout so we don't “hang”
  const timeoutMs = 1800;
  const withTimeout = (p)=>Promise.race([p, new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')), timeoutMs))]);

  try{
    // try both parts concurrently; if both fail or timeout, fall back to single
    const [p1,p2] = await Promise.allSettled([
      withTimeout(streamPickURL(CITY_PARTS[0])),
      withTimeout(streamPickURL(CITY_PARTS[1]))
    ]);
    const ok = [p1,p2].filter(x=>x.status==='fulfilled').map(x=>x.value);
    if(ok.length){
      // choose the globally best (smallest key) across parts
      return ok.reduce((a,b)=> a._key<b._key ? a : b);
    }
  }catch(_){}

  try{
    return await withTimeout(streamPickURL(CITY_SINGLE));
  }catch(_){
    // Remote failed/timed out — fall back to local upload automatically
    fileWrap.classList.add('open');
    return new Promise((resolve,reject)=>{
      fileInput.onchange = async (e)=>{ try{ const city=await pickFromFiles(e.target.files); resolve(city); } catch(err){ reject(err); } };
    });
  }
}

/* ========= IDB (country list + age table) with localStorage cache ========= */
let idbCountryList=null;
const NAME_FIX = new Map(Object.entries({
  "cote d'ivoire":"côte d'ivoire",
  "ivory coast":"côte d'ivoire",
  "congo (kinshasa)":"democratic republic of the congo",
  "congo, democratic republic of the":"democratic republic of the congo",
  "congo (brazzaville)":"congo",
  "russia":"russian federation",
  "south korea":"republic of korea",
  "north korea":"people's republic of korea",
  "swaziland":"eswatini",
  "czech republic":"czechia",
  "macedonia":"tfyr macedonia"
}));
function lsGet(k){ try{ return JSON.parse(localStorage.getItem(k)||'null'); }catch{ return null; } }
function lsSet(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }

async function fetchIdbCountryList(){
  if(idbCountryList) return idbCountryList;
  const ck = `idb_c_${YEAR}`;
  const cached = lsGet(ck);
  if(cached){ idbCountryList=cached; return idbCountryList; }
  const url = `${IDB_BASE}?get=NAME,GENC&YR=${YEAR}&for=genc%20standard%20countries%20and%20areas:*`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('IDB country list error');
  const json = await res.json();
  idbCountryList = json.slice(1).map(r=>({ name:r[0], genc:r[1], norm:normName(r[0]) }));
  lsSet(ck, idbCountryList);
  return idbCountryList;
}
function bestCountryMatch(input){
  if(!input) return null;
  let q = normName(input);
  if(NAME_FIX.has(q)) q = NAME_FIX.get(q);
  const list = idbCountryList || [];
  const exact = list.find(c=>c.norm===q);
  if(exact) return exact;
  const starts = list.find(c=>c.norm.startsWith(q)) || list.find(c=>q.startsWith(c.norm));
  if(starts) return starts;
  return list.find(c=>c.norm.includes(q)) || null;
}
async function fetchIdbAgeTable(genc){
  const ck = `idb_${genc}_${YEAR}`;
  const cached = lsGet(ck); if(cached) return cached;
  const url = `${IDB_BASE}?get=AGE,SEX,POP&YR=${YEAR}&AGE=0:100&SEX=1,2&for=genc%20standard%20countries%20and%20areas:${encodeURIComponent(genc)}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('IDB ages error');
  const data = await res.json();
  const rows = data.slice(1);
  const male = Array(101).fill(0), female = Array(101).fill(0);
  for(const r of rows){
    const age = parseInt(r[0],10), sex = parseInt(r[1],10), pop = Number(r[2]);
    if(Number.isFinite(age) && age>=0 && age<=100 && Number.isFinite(pop)){
      if(sex===1) male[age]+=pop; else if(sex===2) female[age]+=pop;
    }
  }
  const out={male,female}; lsSet(ck,out); return out;
}

/* ========= Sampling ========= */
function pickWeightedIndex(weights){
  let total=0; for(const w of weights){ total += (w>0? w:0); }
  if(total<=0) return Math.floor(Math.random()*weights.length);
  let r=Math.random()*total;
  for(let i=0;i<weights.length;i++){ r -= (weights[i]>0?weights[i]:0); if(r<=0) return i; }
  return weights.length-1;
}
function sampleSexFrom(maleArr,femaleArr){
  const m = maleArr.reduce((s,x)=>s+x,0), f = femaleArr.reduce((s,x)=>s+x,0);
  if(m+f<=0) return Math.random()<0.5?'Male':'Female';
  return (Math.random()*(m+f) < m) ? 'Male' : 'Female';
}
function sampleAgeFrom(maleArr,femaleArr,sex){
  const w = (sex==='Male') ? maleArr : femaleArr;
  return pickWeightedIndex(w); // 0..100 (100 = 100+)
}

/* ========= Show ========= */
function showPlace(c, sex, age){
  if(currentMarker){ map.removeLayer(currentMarker); currentMarker=null; }
  const label=[c.name, c.sub||null, c.country||null].filter(Boolean).join(' — ');
  if(labelsOverlay && !map.hasLayer(labelsOverlay)) labelsOverlay.addTo(map);

  map.flyTo([c.lat, c.lon], 9, {animate:true, duration:2.6, easeLinearity:0.2});
  const done=()=>{ map.off('moveend', done);
    currentMarker=L.marker([c.lat,c.lon]).addTo(map);
    const popStr = c.pop!=null ? fmt(c.pop) : '—';
    currentMarker.bindPopup(`<b>${label}</b><br>Population: ${popStr}<br>${sex}${age!=null?`, age ${age}`:''}`).openPopup();
  };
  map.on('moveend', done);

  document.getElementById('placeTitle').textContent = c.name;
  document.getElementById('placeSub').textContent   = [c.sub, c.country].filter(Boolean).join(' — ') || '—';
  document.getElementById('placePop').textContent   = c.pop!=null ? fmt(c.pop) : '—';
  document.getElementById('sexLbl').textContent     = sex;
  document.getElementById('ageLbl').textContent     = (age!=null ? String(age) : '—');
  panel.classList.add('open');
}

/* ========= Boot ========= */
window.addEventListener('DOMContentLoaded', async ()=>{
  showToast('Loading…');
  try{
    // 1) Get a city quickly: remote with short timeout → else instant local upload
    const city = await tryRemoteThenLocal();

    // 2) Age/sex (empirical) via IDB (cached)
    await fetchIdbCountryList();
    let sex='Male', age=null;
    const match = bestCountryMatch(city.country||'');
    if(match){
      const tbl = await fetchIdbAgeTable(match.genc);
      sex = sampleSexFrom(tbl.male, tbl.female);
      age = sampleAgeFrom(tbl.male, tbl.female, sex);
    }else{
      sex = (Math.random()<0.5 ? 'Male' : 'Female');
    }

    showPlace(city, sex, age);
  }catch(e){
    console.error(e);
    showToast('Could not load a city. Select your CSV when prompted.');
    fileWrap.classList.add('open');
  }
});
</script>
</body>
</html>
